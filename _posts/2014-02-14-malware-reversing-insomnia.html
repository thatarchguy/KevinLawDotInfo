---
layout: post
title: 'Malware Reversing: Insomnia'
date: '2014-02-14T18:25:00.001-08:00'
author: Kevin L
tags: 
modified_time: '2014-02-14T19:08:06.661-08:00'
thumbnail: /images/post_insomnia/thumb_CmzKod7.png
blogger_id: tag:blogger.com,1999:blog-5768106710687360482.post-7777908516455313751
blogger_orig_url: http://blog.kevinlaw.info/2014/02/malware-reversing-insomnia.html
---

Converted from Blogger. Please excuse any layout errors!

Insomnia is a .NET framework Windows PE commanded through IRC that has been around for quite a few years. It has been updated and sold online for $30-$50. I came across this sample, and ran it inside of Cuckoo sandbox. Cuckoo indicated it was part of an IRC botnet, so I immediately started to pick it apart.
<br />
<h4 style="text-align: center;">Insomnia Overview</h4><b>Purpose of Insomnia:</b>
<br />Mass IRC Botnet control
<br />DDoS Attacks
<br />Credential Stealer
<br />
<br /><b>Features of Insomnia include:</b>
<br />5 different DDoS methods to initiate distributed denial of service attacks against a wide variety of targets:
<br />
<ul>
    <li><span style="font-weight: bold;">A</span>pache <span style="font-weight: bold;">R</span>emote <span style="font-weight: bold;">M</span>emory <span style="font-weight: bold;">E</span>xhaustion (A.R.M.E.)</li>
    <li>Slowloris</li>
    <li>Layer7</li>
    <li>Layer4</li>
    <table cellpadding="0" cellspacing="0" class="tr-caption-container" style="clear: right; float: right; margin-bottom: 1em; text-align: right;">
        <tbody>
            <tr>
                <td style="text-align: center;">
                    <a href="/images/post_insomnia/CmzKod7.png" imageanchor="1" style="margin-left: auto; margin-right: auto;"><img border="0" src="/images/post_insomnia/CmzKod7.png" height="152" width="320" />
                    </a>
                </td>
            </tr>
            <tr>
                <td class="tr-caption" style="text-align: center;">Latest Insomnia builder</td>
            </tr>
        </tbody>
    </table>
    <li>UDP&nbsp;</li>
</ul>Filezilla Stealer
<br />IM Stealer
<br />Web Browser Password Stealer (Chrome and Firefox)
<br />Twitter Spread
<br />USB Spread
<br />Registry monitor/persistence
<br />Monitor computer power state
<br />RusKill marks files for deletion upon reboot
<br />BotKiller<b> </b>that is capable of removing bots that use injected threads in explorer.exe. Insomnia is coded to watch and detect many different attributes that malware display.
<br />
<br /><b>IRC Commands:</b>
<br />".v": Version information
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".avinfo": Antivirus information
<br />
<br />".chrome": Steal All Chrome Credentials
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".firefox": Steal all Firefox Credentials
<br />
<br />".j": Join Channel
<br />
<br />".p": Part Channel
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".sort": Joins channel by GeoIPCountry to Sort bots
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".unsort": Leaves the GeoIPCountry channel
<br />
<br />".permsort": if parameter is a, JOIN #admins. Else JOIN #users
<br />
<br />".twitter": Twitter Spread
<br />
<br />".ftp": Steal Filezilla saved credentials
<br />
<br />".bk": BotKiller if parameter is -i, explorerFlash. Else just initiate botkiller
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".rc": Reconnect bot
<br />
<br />".up": Update Bot
<br />
<br />".rm": Uninstall bot
<br />
<br />".dl": Download Exe File
<br />
<br />".m": if parameter = on, then IRC Muted = true. If parameter = off, Then IRC Muted = false
<br />
<br />".arme": ARME flood
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".layer7": Layer7 Flood
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".layer4": Layer4 Flood
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".udp": UDP Flood
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".slow": Slowloris Flood
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".stop": Stops all Floods
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".read": execute commands from url
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".ruskill": Turns on or off Ruskill
<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
<br />".socks": Connects through socks
<br />
<br />".usb": Turns on or off usb spread
<br />
<br />
<h4 style="text-align: center;">Reversing Insomnia</h4>
<div style="text-align: left;"><b>Sample SHA256</b>:
    <br />0d2df9914ff16053817a2d31b4ccdb0e2113dc96d1c499465c0be65444cd3538
    <br />
    <br /><b>Tools Used:</b>
    <br />Cuckoo Sandbox
    <br />Ollydbg
    <br />JetBrains DotPeek
    <br />Visual Studio 2013
    <br />
    <br />
    <br /><b>Notable Strings:</b>
    <br />$: strings 0d2df9914ff16053817a2d31b4ccdb0e2113dc96d1c499465c0be65444cd3538&nbsp; | grep 'CorExeMain'
    <br />&nbsp;_CorExeMain
    <br />"When a .NET executable loads, its entry point is usually a tiny stub of code. That stub just jumps to an exported function in MSCOREE.DLL (_CorExeMain or _CorDllMain)" (http://a5.tf/Dbg)
    <br />
    <br />&nbsp;$: strings 0d2df9914ff16053817a2d31b4ccdb0e2113dc96d1c499465c0be65444cd3538&nbsp; | grep -i 'channel'
    <br />channel
    <br />_mainChannel
    <br />mainChannel
    <br />mainChannelKey
    <br />
    <br />$: strings 0d2df9914ff16053817a2d31b4ccdb0e2113dc96d1c499465c0be65444cd3538&nbsp; | grep -i 'botnick'
    <br />botNick
    <br />BotNick
    <br />
    <br />The mainChannel and botNick strings were enough to give away it was joining an IRC server.
    <br />
    <br />
    <br />Because of the indicator that the executable was .NET framework. I switched over to DotPeak,
    <br />
    <br />
    <table cellpadding="0" cellspacing="0" class="tr-caption-container" style="float: left; text-align: left;">
        <tbody>
            <tr>
                <td style="text-align: center;">
                    <a href="/images/post_insomnia/functions.PNG" style="clear: left; margin-bottom: 1em; margin-left: auto; margin-right: auto;"><img border="0" src="/images/post_insomnia/functions.PNG" height="320" width="231" />
                    </a>
                </td>
            </tr>
            <tr>
                <td class="tr-caption" style="text-align: center;">Insomnia Functions</td>
            </tr>
        </tbody>
    </table>
    <br />DotPeek was very informative because it was able to disassemble the sample. The source code became cleartext, and I was able to fully understand what the sample was doing. The code was extremely well written compared to other samples I have seen.
    <br />
    <br />
    <br />I was able to export the sample from DotPeek into Visual Studio 2013, and begin to start debugging and reversing.
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />There is a snippet of code in Config.cs with all of the customizable configurations :</div>
<div style="text-align: left;">
    <br />
</div>
<div style="text-align: left;"><pre>    public static string currentPath = Process.GetCurrentProcess().MainModule.FileName;<br />&nbsp;&nbsp;&nbsp; public static string randomID = Functions.RandomString(7);<br />&nbsp;&nbsp;&nbsp; public static string botNick = Functions.BotNick();<br />&nbsp;&nbsp;&nbsp; public static string botMD5 = Functions.GetMD5Hash(Config.currentPath);<br />&nbsp;&nbsp;&nbsp; public static string version = "2.2.0";<br />&nbsp;&nbsp;&nbsp; public static string regLocation = "HKCU";<br />&nbsp;&nbsp;&nbsp; public static string socksUser = Config.randomID;<br />&nbsp;&nbsp;&nbsp; public static string socksPass = Convert.ToBase64String(Encoding.UTF8.GetBytes(Config.randomID)).Substring(0, 5);<br />&nbsp;&nbsp;&nbsp; public static bool topicAct = false;<br />&nbsp;&nbsp;&nbsp; private static string enc = "[Redacted Base64 String]";<br />&nbsp;&nbsp;&nbsp; private static string toParse = Encoding.UTF8.GetString(Convert.FromBase64String(Config.enc));<br />&nbsp;&nbsp;&nbsp; public static string customerID = Config.toParse.Substring(0, 8);<br />&nbsp;&nbsp;&nbsp; private static string[] nfo = Functions.Chk(new Data().decrypt(Config.toParse.Remove(0, 8)), Convert.ToInt32(Config.customerID)).Split(new char[1]<br />&nbsp;&nbsp;&nbsp; {<br />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; '/'<br />&nbsp;&nbsp;&nbsp; });&nbsp;</pre><pre>&nbsp;</pre>The problem is that all of the configurations stem from the string "enc". This is an encrypted string that needs to be reversed before we can figure out who the attacker is.
    <br /><pre>&nbsp;</pre><b>Decryption Algorithm: </b>
</div>
<div class="separator" style="clear: both; text-align: center;"></div>enc Base64 - &gt; UTF8 -&gt; First 8 characters removed and go to CustID -&gt; Converted to Int32,
<br />
<br />Data.Decrypt Function on rest of characters (80 lines of character swapping)&nbsp; -&gt; Decrypted string with CustID used as key for Functions.Chk -&gt; All split at "/" into nfo[] array
<br />
<br />I ended up writing a C# program to reverse the encryption algorithm it uses.
<br />
<br />
<div class="separator" style="clear: both; text-align: center;">
    <a href="/images/post_insomnia/decrypt.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;"><img border="0" src="/images/post_insomnia/decrypt.png" height="267" width="640" />
    </a>
</div>
<br />&nbsp;Source code can be found<a href="http://github.com/thatarchguy/Insomnia-Decrypt-Code" target="_blank"> here</a>.
<br />
<br /><b>Results:</b>
<br />Disassembling and reversing the encryption leads to a domain name which hosts the IRC server. Most of the server names are using a dynamic dns service like no-ip or dyndns.
<br />We can connect to the IRC and start issuing commands, like in my other entry,&nbsp; <a href="http://kevinlaw.info/blog/to-catch-hacker-honeypot-edition" target="_blank">To Catch a Hacker</a>.